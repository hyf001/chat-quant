# ==================== 第一阶段：Python镜像 ====================
# 开发环境：使用公共Python镜像（基于相同的Debian版本）
FROM python:3.12-slim-bookworm AS python-builder

# ==================== 第二阶段：Node.js镜像 ====================
# 开发环境：使用公共Node.js镜像
FROM node:22-bookworm-slim AS node-builder

# ==================== 第三阶段：构建最终镜像 ====================
# 开发环境：使用公共Node.js镜像作为基础（bookworm = Debian 12，有GLIBC 2.36）
FROM node:22-bookworm-slim

# 设置工作目录
WORKDIR /app

# 创建Python目标目录
RUN mkdir -p /usr/local/python/bin /usr/local/python/lib /usr/local/python/include

# 从Python镜像复制Python环境
# 公共Python镜像的Python在 /usr/local/ 下，需要复制到 /usr/local/python/ 以保持与生产环境一致
COPY --from=python-builder /usr/local/bin/python* /usr/local/python/bin/
COPY --from=python-builder /usr/local/bin/pip* /usr/local/python/bin/
COPY --from=python-builder /usr/local/lib/python3.12 /usr/local/python/lib/python3.12
COPY --from=python-builder /usr/local/lib/libpython3.12.so* /usr/local/python/lib/
COPY --from=python-builder /usr/local/lib/libpython3.so /usr/local/python/lib/
COPY --from=python-builder /usr/local/include/python3.12 /usr/local/python/include/python3.12

# 设置环境变量
ENV PATH=/usr/local/python/bin:/usr/local/bin:/usr/bin:$PATH \
    PYTHONPATH=/usr/local/python/lib/python3.12/site-packages \
    LD_LIBRARY_PATH=/usr/local/python/lib:$LD_LIBRARY_PATH \
    PYTHONUNBUFFERED=1 \
    NODE_ENV=production \
    API_PORT=8000 \
    WEB_PORT=3000

# 验证Python和Node环境
RUN python --version && node --version && npm --version

# 复制项目文件
COPY . /app/

# ==================== 安装依赖 ====================

# 配置npm使用淘宝镜像源
RUN npm config set registry https://registry.npmmirror.com

# 安装根目录依赖（跳过postinstall脚本，因为容器中不需要虚拟环境）
RUN npm install --ignore-scripts || echo "No root dependencies"

# 安装前端依赖
WORKDIR /app/apps/web
RUN npm install --omit=optional --no-audit --no-fund

# 构建前端（可选，根据需要）
# RUN npm run build

# 配置pip使用阿里云镜像源
RUN pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/ && \
    pip config set global.trusted-host mirrors.aliyun.com

# 安装Python依赖（直接安装到容器的Python环境）
WORKDIR /app/apps/api
RUN pip install --no-cache-dir -r requirements.txt

# 验证关键Python包
RUN python -c "import fastapi; import uvicorn; import sqlalchemy; print('Python dependencies OK')"

# ==================== 准备运行环境 ====================

# 创建日志目录
RUN mkdir -p /var/log/claudable

# 创建数据目录
RUN mkdir -p /app/data/projects

# 复制启动脚本
COPY docker/start.sh /app/start.sh
RUN chmod +x /app/start.sh

# 回到应用根目录
WORKDIR /app

# 暴露端口
EXPOSE 3000 8000

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:3000/ || exit 1

# 启动服务
CMD ["/app/start.sh"]
